%h1 &nbsp;
- products = []
- customers = []
= form_tag( ENV["pre_fix_url"]+place_bulk_order_path(action_type: 'save_orders'), method: :post, id: 'order_place') do
  .row
    .col-xs-20
      %div{class: "col-md-2 col-sm-2 col-xs-2 text-left", style: 'width: auto;'}
        = link_to 'Place Order', "#", class: 'btn btn-primary' , onclick: "$('form#order_place').submit();"
      .col-md-2.col-sm-2.col-xs-2.text-center
        .col-md-6.col-sm-12.col-xs-12
          = link_to '+ Product' , ENV["pre_fix_url"]+place_bulk_order_path(action_type: 'list-product', locations: session[:bulk_order]['distributors']||[], products: session[:bulk_order]['products']||[]), class: 'btn glyphicon1 glyphicon-plus1 btn-primary'
        %br{class: 'visible-sm visible-xs'}
        .col-md-6.col-sm-12.col-xs-12
          = link_to '+ Locations' , ENV["pre_fix_url"]+place_bulk_order_path(action_type: 'list-location', locations: session[:bulk_order]['distributors']||[], products: session[:bulk_order]['products']||[]), class: 'btn glyphicon1 glyphicon-plus1 btn-primary'
      .col-md-7.col-sm-7.col-xs-7.text-center
        .col-md-4.col-sm-4.col-xs-4
          %strong Total Products<br class='visible-sm visible-xs'>
          .btn.glyphicon.btn-primary.total-products
            0
        .col-md-4.col-sm-4.col-xs-4
          %strong Total Amount<br class='visible-sm visible-xs'>
          .btn.glyphicon.btn-primary.total-amount
            0
        .col-md-4.col-sm-4.col-xs-4
          %strong Shipping<br class='visible-sm visible-xs'>
          = select_tag "shipping_type", options_for_select(get_shipping_options)
      .col-md-1.col-sm-1.col-xs-1.pull-right
        = link_to 'Clear Bulk Order ', ENV["pre_fix_url"]+place_bulk_order_path(action_type: 'session_clear'), class: 'btn btn-success clear-cacheing pull-right'
  - (session[:bulk_order]['distributors']||[]).each do |v|
    = hidden_field_tag "locations[]", v
  - (session[:bulk_order]['products']||[]).each do |v|
    = hidden_field_tag "products[]", v
  %hr   
  .col-md-6.col-sm-6.col-xs-6
    - if session[:bulk_order].present? && session[:bulk_order]['products'].present?
      %div{style: 'height:200px'}
        %div{class: "col-xs-12 col-md-5", style: 'font-weight: bolder;'}
          POP Element
        %div{class: "col-xs-12 distributor-total-quantity total-info", style: "width: 100px;"}
          Total 
          Quantity
        %div{class: "col-xs-12 distributor-total-amount total-info", style: "width: 100px;"}
          Total 
          Price
        %div{class: "col-xs-12 distributor-total-amount total-info", style: "width: 100px;"}
          Shipping 
          Cost  
    - if session[:bulk_order].present? && session[:bulk_order]['distributors'].present?
      - if session[:bulk_order].present? && session[:bulk_order]['products'].present? && session[:bulk_order]['distributors'].present?
        %div{class: "col-xs-12 col-md-7 total-info",style: 'width: 500px;'}
          Total Quantity
        .total-price
          %div{class: "col-xs-12 col-md-7 total-info",style: 'width: 500px;'}
            Total Price
      %br
      - customers.each do |customer|
        - distributor_id = customer.id.to_s
        - if customer.present?
          - default_address = customer.default_address rescue nil
          - if default_address.present?
            %div{style: 'height:75px'}
              %div{class: "col-xs-12 col-md-5"}
                = "#{default_address.address1}, #{default_address.city}"
                - if @error_message.present? 
                  - if @error_message[distributor_id].present?
                    .error-message
                      = @error_message[distributor_id].html_safe
              - if products.present?
                %div{class: "col-xs-12 distributor-total-quantity-#{distributor_id}", style: "width: 100px;"}
                  0
                %div{class: "col-xs-12 distributor-total-amount-#{distributor_id}", style: "width: 100px;"}
                  0
                %div{class: "col-xs-12 distributor-shipping-amount distributor-total-shipping-amount-#{distributor_id}", style: "width: 100px;"}
                  0
              %div
                - products.each do |product|
                  - variant = product.variants.first
                  %div{class: "col-xs-12", style: "width: 160px;"}
              =  hidden_field_tag "order[distributors][#{distributor_id}]shipping_amount" ,0 , id: "shipping-#{distributor_id}"
  .col-md-6.col-sm-6.col-xs-6
    - if session[:bulk_order].present? && session[:bulk_order]['products'].present?
      - place_height = session[:bulk_order]['distributors'].present? ? 75 * session[:bulk_order]['distributors'].size + 300 : 300
      .DocumentList{style: "height: #{place_height}px"}  
        %ul{class: 'list-inline',style: "height: #{place_height}px"}
          - products = ShopifyAPI::Product.find(:all, params: {ids: session[:bulk_order]['products'].join(',')}) 
          - products.each do |product|
            - product_id = product.id
            - variant = product.variants.first
            %li{class: 'DocumentItem' ,style: "height: #{place_height}px"}
              %div{style: 'height:200px'}
                =# image_tag product.image.src, style: 'width:100px;'
                = link_to image_tag(product.image.src, style: 'width:100px;') , ENV["pre_fix_url"]++place_bulk_order_path(action_type: 'product-detail-pop', product_id: product.id,locations: session[:bulk_order]['distributors']||[], products: session[:bulk_order]['products']||[]), class: 'fancybox' , remote: true
                %br
                %br
                .product-title.ellipses
                  = product.title
                %br
                = variant.price
                - custom_product = Product.find_by_shopify_product_id(product_id)
                - min_quantity = custom_product.blank? || custom_product.min_quantity.blank? ? 'Quantity' : "Quantity <= #{custom_product.min_quantity}"
                - if @orders.present?
                  - value = params[:order][:distributors][distributor_id]['product'][product.id.to_s]['quantity']
                - else
                  - value = custom_product.present? ? custom_product.min_quantity : 0
                - default_price = custom_product.present? ? custom_product.get_price(value, variant.price) : variant.price
              %div{class: "col-xs-12 product-total-quantity-#{product.id}"}
                0
              %div{class: "col-xs-12 product-total-amount-#{product.id}"}
                0
              %br
              - if session[:bulk_order].present? && session[:bulk_order]['distributors'].present?
                - customers = ShopifyAPI::Customer.find(:all, params: {ids: session[:bulk_order]['distributors'].join(',')})
                - customers.each do |customer|
                  - distributor_id = customer.id
                  - default_value = custom_product.present? ? custom_product.min_quantity : 0
                  - if customer.present?
                    - default_address = customer.default_address rescue nil
                    - if default_address.present?
                      %div{style: 'height:75px;width:110px'}
                        =  text_field_tag "order[distributors][#{distributor_id}][product][#{product.id}]quantity" , value , class: "form-control order-quantity product-#{product.id} distributor-#{distributor_id}", placeholder: min_quantity, id: "order-#{distributor_id}-#{product.id}", product_price: default_price, product_weight: variant.weight, country: default_address.country, province: default_address.province, country_code: default_address.country_code, province_code: default_address.province_code, city: default_address.city, zip: default_address.zip
%br
#loader.none
  = image_tag 'loader.png'
=# li'nk_to 'New Distributor', new_distributor_path ,class: 'btn btn-primary'
=# link_to 'Sync from Shop', sync_distributors_path ,class: 'btn btn-primary'

:javascript
  $( ".order-quantity" ).each(function() {
    cacheing_value = getCookie($(this).attr('id'))
    if(typeof cacheing_value != "undefined"){
      $(this).val(cacheing_value)
    }      
    if(parseInt($(this).val()) > 0){
      update_product_price($(this).attr('id'), $(this).val());
    }
  });
  var ca = document.cookie.split(';');
  for(var i = 0; i <ca.length; i++) {
      if(ca.indexOf('order-' == 0)){
          var c = ca[i].split('=')[0];
          console.log(c);
          if($('#'+c.trim()).length == 0){
            document.cookie = c + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          }

      }
  }
